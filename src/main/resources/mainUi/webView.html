<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="map">
    <section id="tsp">
    </section>
</div>

<ul class='custom-menu'>
    <li data-action="addNewCity">Create City Here</li>
    <li data-action="linkCityTo" id="cm-linkCity">Link this City</li>
    <li data-action="removeLink" id="cm-removeLink">Remove this link</li>
</ul>

<script src="d3.min.js" type="application/javascript"></script>
<script src="underscore.min.js" type="application/javascript"></script>
<script src="jquery-3.1.1.min.js" type="application/javascript"></script>
<script src="tsp.js" type="application/javascript"></script>
<script>

    //   NOTES :
    // We could optimize the data transfer between Javscript and JavaFX
    // But this is not the purpose, and it work good enough to keep it as it

    /**
     * Application
     */
    var app = null;

    // Store all the document div to be accessed in other functions

    /**
     * Get the name of a function
     * @param  fun function : the function to get the name
     * @return string the function name
     */
    function getFunctionName(fun) {
        var ret = fun.toString();
        ret = ret.substr('function '.length);
        ret = ret.substr(0, ret.indexOf('('));
        return ret;
    }

    /**
     * Application class used to map the JsApp and the Javascript
     * So we can write real javascript without caring about how
     * we send or get the information
     * @return {{onMapChange: onMapChange, sendNewTspMap: sendNewTspMap}}
     * @constructor
     */
    function Application(){
        var _jap = javaApp;
        return {
            onMapChange: function(arg){
                _jap.onMapChange(getFunctionName(arg));
            },
            sendNewTspMap: function(action, arg){
                _jap.sendNewTspMap(action, JSON.stringify(arg));
            }
        }
    }

    // Initialisation
    function init(){

        // this is used in testing when launching the html in normal browser
        if(!window.javaApp){
            var info = function(e){
                console.log(e);
            };
            info("#---------------# \n Recreating javaApp from the Controller.JsApplication perspective \n #---------------# \n\n");
            javaApp = {
                onMapChange: function(arg){
                    info(arg);
                },
                sendNewTspMap: function(action, arg){
                    info(action);
                    info(JSON.parse(arg));
                }
            }
        }

        // Application init()
        app = Application();

        // Request to the app to launch testCallback on every map change
        app.onMapChange(newMapReceived);

        // Request modification from tsp lib
        tspDrawer.onModification(onMapModification);
    }

    // App functions | Those one should exchange with JavaFX

    /**
     * Called when the data from the TSP mapC
     * changed in Java
     * Should callback a redraw
     * @param args
     */
    function newMapReceived(args){
        tspDrawer.drawState(args);
    }

    /**
     * This function is triggered every time
     * the map state is updated in the tsp.js
     * And should send back to JavaFX the new
     * State
     * @param action the action sent
     * @param e the string arg
     */
    function onMapModification(action, e){
        console.log(action);
        app.sendNewTspMap(action, e);
    }

    /**
     * Call init if it hasnt been called in 1s
     * this basically means we are not using JavaFX
     * Open the console and launch manualInit();
     */
    function manualInit(){
        init();
        var map = '{"cities":[{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}, {"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}}, {"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}}, {"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}}, {"name":"City 4","vertexInfo":{"x":47.318478,"y":5.032734}}], "edges":[{"from":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}},"to":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}}, {"from":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}},"to":{"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}}}, {"from":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}},"to":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}}}, {"from":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}},"to":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}}, {"from":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}},"to":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}}}, {"from":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}},"to":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}}}, {"from":{"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}},"to":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}}}, {"from":{"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}},"to":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}}, {"from":{"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}},"to":{"name":"City 2","vertexInfo":{"x":47.638263,"y":6.855987}}}, {"from":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}},"to":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}}, {"from":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}},"to":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}}}, {"from":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}},"to":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}}}, {"from":{"name":"City 4","vertexInfo":{"x":47.318478,"y":5.032734}},"to":{"name":"City 1","vertexInfo":{"x":47.241318,"y":6.007459}}}, {"from":{"name":"City 4","vertexInfo":{"x":47.318478,"y":5.032734}},"to":{"name":"City 0","vertexInfo":{"x":46.738914,"y":5.903777}}}, {"from":{"name":"City 4","vertexInfo":{"x":47.318478,"y":5.032734}},"to":{"name":"City 3","vertexInfo":{"x":46.20241,"y":6.137136}}}]}';
        newMapReceived(map);
    }manualInit();

</script>
</body>
</html>